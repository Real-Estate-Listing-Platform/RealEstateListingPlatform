@using System.Linq
@model IEnumerable<RealEstateListingPlatform.Models.ListingApprovalViewModel>

@{
    var items = Model?.ToList() ?? new List<RealEstateListingPlatform.Models.ListingApprovalViewModel>();
}

<div class="card admin-card border-0 shadow-sm mt-3">
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-hover mb-0 align-middle admin-table">
                <thead class="bg-light">
                    <tr>
                        <th class="ps-4 py-3 border-0 text-uppercase small fw-bold text-muted">Submission</th>
                        <th class="py-3 border-0 text-uppercase small fw-bold text-muted">Property Info</th>
                        <th class="py-3 border-0 text-uppercase small fw-bold text-muted d-none d-lg-table-cell">Price</th>
                        <th class="py-3 border-0 text-uppercase small fw-bold text-muted d-none d-md-table-cell">Lister</th>
                        <th class="py-3 border-0 text-uppercase small fw-bold text-muted text-center">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    @if (!items.Any())
                    {
                        <tr>
                            <td colspan="5" class="text-center py-5 text-muted">
                                No pending listings right now.
                            </td>
                        </tr>
                    }
                    else
                    {
                        foreach (var item in items)
                        {
                            var listerInitial = string.IsNullOrWhiteSpace(item.ListerName)
                                ? "?"
                                : item.ListerName.Trim().Substring(0, 1).ToUpperInvariant();
                            <tr>
                                <td class="ps-4">
                                    <div class="fw-bold text-dark">@item.CreatedAt.ToString("MMM dd")</div>
                                    <div class="text-muted small">@item.CreatedAt.ToString("HH:mm")</div>
                                </td>
                                <td>
                                    <div class="fw-bold text-primary text-truncate" style="max-width: 220px;">
                                        @item.Title
                                        @if (item.IsUpdate)
                                        {
                                            <span class="badge bg-warning text-dark ms-2" title="This is an update to an existing listing">
                                                <i class="bi bi-pencil-square"></i> EDIT
                                            </span>
                                        }
                                    </div>
                                    <div class="text-muted small d-flex align-items-center mt-1">
                                        <span class="badge-type me-2">@item.TransactionType</span>
                                        <span class="d-none d-sm-inline text-truncate"><i class="bi bi-geo-alt me-1"></i>@item.Address</span>
                                    </div>
                                    <div class="d-lg-none mt-1 fw-bold text-dark small">@item.Price.ToString("N0") VND</div>
                                </td>
                                <td class="d-none d-lg-table-cell text-nowrap">
                                    <div class="fw-bold text-dark">@item.Price.ToString("N0") <small>VND</small></div>
                                </td>
                                <td class="d-none d-md-table-cell">
                                    <div class="d-flex align-items-center">
                                        <div class="admin-avatar me-2">@listerInitial</div>
                                        <span class="text-dark small">@item.ListerName</span>
                                    </div>
                                </td>
                                <td class="text-center pe-4">
                                    <div class="btn-group rounded-pill overflow-hidden border shadow-sm bg-white">
                                        @if (item.IsUpdate)
                                        {
                                            <!-- Show comparison button for edits -->
                                            <button class="btn btn-sm btn-white px-3" onclick="showComparison('@item.Id')" title="View Changes">
                                                <i class="bi bi-arrows-angle-expand text-info"></i>
                                            </button>
                                        }
                                        else
                                        {
                                            <!-- Show details button for new listings -->
                                            <button class="btn btn-sm btn-white px-3" data-bs-toggle="modal" data-bs-target="#detailsModal-@item.Id" title="View Details">
                                                <i class="bi bi-eye text-primary"></i>
                                            </button>
                                        }

                                        <button class="btn btn-sm btn-white px-3 border-start" data-bs-toggle="modal" data-bs-target="#approveModal-@item.Id" title="Approve">
                                            <i class="bi bi-check2-circle text-success"></i>
                                        </button>

                                        <button class="btn btn-sm btn-white px-3 border-start" data-bs-toggle="modal" data-bs-target="#rejectModal-@item.Id" title="Reject">
                                            <i class="bi bi-slash-circle text-danger"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        }
                    }
                </tbody>
            </table>
        </div>
    </div>
</div>

@if (items.Any())
{
    foreach (var item in items)
    {
        <div class="modal fade" id="detailsModal-@item.Id" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
                <div class="modal-content border-0 shadow-lg" style="border-radius: 20px;">
                    <div class="modal-header border-0 pb-0">
                        <h5 class="fw-bold text-dark pt-3 ps-2">Property Details</h5>
                        <button type="button" class="btn-close me-2 mt-2" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body text-start p-4">
                        <h4 class="text-primary fw-bold">@item.Title</h4>
                        <p class="text-muted small mb-4"><i class="bi bi-geo-alt me-1"></i>@item.Address</p>

                        @{
                            var imageUrls = (item.ImageUrls ?? new List<string>())
                                .Where(url => !string.IsNullOrWhiteSpace(url))
                                .ToList();
                            if (!imageUrls.Any() && !string.IsNullOrWhiteSpace(item.ImageUrl))
                            {
                                imageUrls.Add(item.ImageUrl);
                            }
                            var galleryImages = imageUrls.Take(6).ToList();
                        }
                        @if (galleryImages.Any())
                        {
                            <div class="admin-listing-gallery mb-4">
                                <div class="row g-2">
                                    @foreach (var url in galleryImages)
                                    {
                                        <div class="col-6 col-md-4">
                                            <div class="admin-gallery-tile">
                                                <img src="@url" alt="Listing image" loading="lazy" />
                                            </div>
                                        </div>
                                    }
                                </div>
                            </div>
                        }
                        else
                        {
                            <div class="admin-listing-gallery-empty mb-4">
                                <span class="text-muted small">No images uploaded.</span>
                            </div>
                        }

                        <div class="row g-3 mb-4 text-center">
                            <div class="col-6 col-md-3">
                                <div class="p-3 bg-light rounded-4">
                                    <i class="bi bi-rulers d-block mb-1 text-primary"></i>
                                    <small class="text-muted d-block">Area</small>
                                    <span class="fw-bold small">@item.Area m2</span>
                                </div>
                            </div>
                            <div class="col-6 col-md-3">
                                <div class="p-3 bg-light rounded-4">
                                    <i class="bi bi-door-closed d-block mb-1 text-primary"></i>
                                    <small class="text-muted d-block">Beds</small>
                                    <span class="fw-bold small">@item.Bedrooms</span>
                                </div>
                            </div>
                            <div class="col-6 col-md-3">
                                <div class="p-3 bg-light rounded-4">
                                    <i class="bi bi-droplet d-block mb-1 text-primary"></i>
                                    <small class="text-muted d-block">Baths</small>
                                    <span class="fw-bold small">@item.Bathrooms</span>
                                </div>
                            </div>
                            <div class="col-6 col-md-3">
                                <div class="p-3 bg-light rounded-4">
                                    <i class="bi bi-layers d-block mb-1 text-primary"></i>
                                    <small class="text-muted d-block">Floors</small>
                                    <span class="fw-bold small">@item.Floors</span>
                                </div>
                            </div>
                        </div>

                        <div class="row mb-4 ps-1">
                            <div class="col-md-4 mb-2"><span class="text-muted small">Legal:</span> <span class="fw-bold small ms-1">@item.LegalStatus</span></div>
                            <div class="col-md-4 mb-2"><span class="text-muted small">Furniture:</span> <span class="fw-bold small ms-1">@item.FurnitureStatus</span></div>
                            <div class="col-md-4 mb-2"><span class="text-muted small">Direction:</span> <span class="fw-bold small ms-1">@item.Direction</span></div>
                        </div>

                        <div class="p-3 rounded-4 bg-light">
                            <label class="fw-bold small text-muted mb-2 d-block">Description</label>
                            <div class="small text-dark" style="white-space: pre-line;">@item.Description</div>
                        </div>
                    </div>
                    <div class="modal-footer border-0 p-4 pt-0">
                        <button type="button" class="btn btn-auth-primary w-100 py-2" data-bs-dismiss="modal">Close Review</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="modal fade" id="approveModal-@item.Id" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content border-0 shadow-lg" style="border-radius: 20px;">
                    <form asp-action="Approve" method="post">
                        <input type="hidden" name="id" value="@item.Id" />
                        <div class="modal-header border-0">
                            <h5 class="fw-bold text-success pt-3 ps-2">Approve Submission</h5>
                            <button type="button" class="btn-close me-2 mt-2" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body p-4 pt-2">
                            <p class="mb-3">Are you sure you want to approve this listing?</p>
                            <div class="p-3 bg-light rounded-4">
                                <div class="fw-bold text-dark mb-1">@item.Title</div>
                                <div class="text-muted small"><i class="bi bi-geo-alt me-1"></i>@item.Address</div>
                                <div class="fw-bold text-primary mt-2">@item.Price.ToString("N0") VND</div>
                            </div>
                        </div>
                        <div class="modal-footer border-0 p-4 pt-0">
                            <button type="button" class="btn btn-light rounded-pill px-4" data-bs-dismiss="modal">Cancel</button>
                            <button type="submit" class="btn btn-success rounded-pill px-4">Confirm Approval</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <div class="modal fade" id="rejectModal-@item.Id" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content border-0 shadow-lg" style="border-radius: 20px;">
                    <form asp-action="Reject" method="post">
                        <input type="hidden" name="id" value="@item.Id" />
                        <div class="modal-header border-0">
                            <h5 class="fw-bold text-danger pt-3 ps-2">Reject Submission</h5>
                            <button type="button" class="btn-close me-2 mt-2" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body p-4 pt-2">
                            <label class="form-label small fw-bold text-muted mb-2">Reason for rejection</label>
                            <textarea name="reason" class="form-control bg-light border-0 py-3 px-3 shadow-none"
                                      rows="4" style="border-radius: 12px; resize: none;"
                                      placeholder="Tell the lister why this was rejected..." required></textarea>
                        </div>
                        <div class="modal-footer border-0 p-4 pt-0">
                            <button type="button" class="btn btn-light rounded-pill px-4" data-bs-dismiss="modal">Cancel</button>
                            <button type="submit" class="btn btn-danger rounded-pill px-4">Confirm Reject</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    }
}

<!-- Comparison Modal -->
<div class="modal fade" id="comparisonModal" tabindex="-1" aria-labelledby="comparisonModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable">
        <div class="modal-content border-0 shadow-lg" style="border-radius: 20px;">
            <div class="modal-header border-0 pb-0">
                <h5 class="fw-bold text-dark pt-3 ps-2" id="comparisonModalLabel">
                    <i class="bi bi-arrows-angle-expand me-2"></i>Compare Changes
                </h5>
                <button type="button" class="btn-close me-2 mt-2" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-4" id="comparisonContent">
                <div class="text-center py-5">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
            </div>
            <div class="modal-footer border-0 p-4 pt-0">
                <button type="button" class="btn btn-auth-primary rounded-pill px-4" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<script>
    function showComparison(listingId) {
        // Show modal
        var modal = new bootstrap.Modal(document.getElementById('comparisonModal'));
        modal.show();
        
        // Load comparison content
        var contentDiv = document.getElementById('comparisonContent');
        contentDiv.innerHTML = '<div class="text-center py-5"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div></div>';
        
        // Fetch comparison data
        fetch('/Admin/GetComparison?id=' + listingId)
            .then(response => {
                if (!response.ok) {
                    throw new Error('Failed to load comparison');
                }
                return response.text();
            })
            .then(html => {
                contentDiv.innerHTML = html;
            })
            .catch(error => {
                console.error('Error loading comparison:', error);
                contentDiv.innerHTML = '<div class="alert alert-danger"><i class="bi bi-exclamation-triangle me-2"></i>Failed to load comparison data. Please try again.</div>';
            });
    }
</script>

<style>
    /* Remove modal backdrop - display modals without blurring/darkening the background */
    .modal-backdrop {
        display: none !important;
    }
    
    /* Ensure modal is still clickable and visible */
    .modal.show {
        background-color: transparent;
    }
</style>


